!function(e){"use strict";e.fn.mapael=function(t){return t=e.extend(!0,{},e.fn.mapael.defaultOptions,t),this.each(function(){var a=e(this),n=e("<div>").addClass(t.map.tooltip.cssClass).css("display","none"),i=e("."+t.map.cssClass,this).empty().append(n),o=e.fn.mapael.maps[t.map.name],l=new Raphael(i[0],o.width,o.height),s={},r=0,m={},p={},f={},d={},c=0;t.map.tooltip.css&&n.css(t.map.tooltip.css),l.setViewBox(0,0,o.width,o.height,!1);for(c in o.elems)s=e.fn.mapael.getElemOptions(t.map.defaultArea,t.areas[c]?t.areas[c]:{},t.legend.area),m[c]={mapElem:l.path(o.elems[c]).attr(s.attrs)};for(c in o.elems)s=e.fn.mapael.getElemOptions(t.map.defaultArea,t.areas[c]?t.areas[c]:{},t.legend.area),e.fn.mapael.initElem(l,m[c],s,n,c);for(c in t.plots)p[c]=e.fn.mapael.drawPlot(c,t,o,l,n);if(t.map.zoom.enabled&&e.fn.mapael.initZoom(i,l,o.width,o.height,t.map.zoom),t.legend.area.slices&&t.legend.area.display&&(f=e.fn.mapael.createLegend(a,t,"area",m,1)),a.on("update",function(i,s,r,c,u){var x=0,h=0,E=0,g={},v=function(t){"undefined"!=typeof t.hidden&&1==t.hidden&&e(t.node).trigger("click")};if(f.forEach&&f.forEach(v),d.forEach&&d.forEach(v),"undefined"!=typeof u&&(u.resetAreas&&(t.areas={}),u.resetPlots&&(t.plots={}),u.animDuration&&(E=u.animDuration)),e.extend(!0,t,s),"object"==typeof c)for(;x<c.length;x++)"undefined"!=typeof p[c[x]]&&(E>0?!function(e){e.mapElem.animate({opacity:0},E,"linear",function(){e.mapElem.remove()}),e.textElem&&e.textElem.animate({opacity:0},E,"linear",function(){e.textElem.remove()})}(p[c[x]]):(p[c[x]].mapElem.remove(),p[c[x]].textElem&&p[c[x]].textElem.remove()),delete p[c[x]]);if("object"==typeof r)for(h in r)"undefined"==typeof p[h]&&(t.plots[h]=r[h],p[h]=e.fn.mapael.drawPlot(h,t,o,l,n),E>0&&(p[h].mapElem.attr({opacity:0}),p[h].textElem.attr({opacity:0}),p[h].mapElem.animate({opacity:"undefined"!=typeof p[h].mapElem.originalAttrs.opacity?p[h].mapElem.originalAttrs.opacity:1},E),p[h].textElem.animate({opacity:"undefined"!=typeof p[h].textElem.originalAttrs.opacity?p[h].textElem.originalAttrs.opacity:1},E)));for(h in m)g=e.fn.mapael.getElemOptions(t.map.defaultArea,t.areas[h]?t.areas[h]:{},t.legend.area),e.fn.mapael.updateElem(g,m[h],n,E);for(h in p)g=e.fn.mapael.getElemOptions(t.map.defaultPlot,t.plots[h]?t.plots[h]:{},t.legend.plot),"square"==g.type?(g.attrs.width=g.size,g.attrs.height=g.size,g.attrs.x=p[h].mapElem.attrs.x-(g.size-p[h].mapElem.attrs.width)/2,g.attrs.y=p[h].mapElem.attrs.y-(g.size-p[h].mapElem.attrs.height)/2):g.attrs.r=g.size/2,e.fn.mapael.updateElem(g,p[h],n,E);u.afterUpdate&&u.afterUpdate(a,l,m,p,t)}),t.map.width)l.setSize(t.map.width,o.height*(t.map.width/o.width)),t.legend.plot.slices&&t.legend.plot.display&&(d=e.fn.mapael.createLegend(a,t,"plot",p,t.map.width/o.width));else{e(window).on("resize",function(){clearTimeout(r),r=setTimeout(function(){i.trigger("resizeEnd")},150)});var u=function(){t.legend.plot.slices&&t.legend.plot.display&&(d=e.fn.mapael.createLegend(a,t,"plot",p,i.width()/o.width)),i.unbind("resizeEnd",u)};i.on("resizeEnd",function(){var e=i.width();l.width!=e&&l.setSize(e,o.height*(e/o.width))}).on("resizeEnd",u).trigger("resizeEnd")}t.map.afterInit&&t.map.afterInit(a,l,m,p,t),e(l.desc).append(" and Mapael (http://neveldo.fr/mapael)")})},e.fn.mapael.initElem=function(t,a,n,i,o){var l={},s={};e.fn.mapael.setHoverOptions(a.mapElem,n.attrs,n.attrsHover),n.text&&"undefined"!=typeof n.text.content?(l=a.mapElem.getBBox(),s=e.fn.mapael.getTextPosition(l,n.text.position,n.text.margin),n.text.attrs["text-anchor"]=s.textAnchor,a.textElem=t.text(s.x,s.y,n.text.content).attr(n.text.attrs),e.fn.mapael.setHoverOptions(a.textElem,n.text.attrs,n.text.attrsHover),e.fn.mapael.setHover(t,a.mapElem,a.textElem),n.eventHandlers&&e.fn.mapael.setEventHandlers(o,n,a.mapElem,a.textElem),e(a.textElem.node).attr("data-id",o)):(e.fn.mapael.setHover(t,a.mapElem),n.eventHandlers&&e.fn.mapael.setEventHandlers(o,n,a.mapElem)),n.tooltip&&n.tooltip.content&&(a.mapElem.tooltipContent=n.tooltip.content,e.fn.mapael.setTooltip(a.mapElem,i),n.text&&"undefined"!=typeof n.text.content&&(a.textElem.tooltipContent=n.tooltip.content,e.fn.mapael.setTooltip(a.textElem,i))),n.href&&(a.mapElem.href=n.href,e.fn.mapael.setHref(a.mapElem),n.text&&"undefined"!=typeof n.text.content&&(a.textElem.href=n.href,e.fn.mapael.setHref(a.textElem))),"undefined"!=typeof n.value&&(a.value=n.value),e(a.mapElem.node).attr("data-id",o)},e.fn.mapael.updateElem=function(t,a,n,i){var o,l,s;"undefined"!=typeof t.value&&(a.value=t.value),a.textElem&&("undefined"!=typeof t.text&&"undefined"!=typeof t.text.content&&t.text.content!=a.textElem.attrs.text&&a.textElem.attr({text:t.text.content}),o=a.mapElem.getBBox(),t.size&&(s=(t.size-o.height)/2,o.x-=s,o.x2+=s,o.y-=s,o.y2+=s),l=e.fn.mapael.getTextPosition(o,t.text.position,t.text.margin),(l.x!=a.textElem.attrs.x||l.y!=a.textElem.attrs.y)&&(i>0?(a.textElem.attr({"text-anchor":l.textAnchor}),a.textElem.animate({x:l.x,y:l.y},i)):a.textElem.attr({x:l.x,y:l.y,"text-anchor":l.textAnchor})),e.fn.mapael.setHoverOptions(a.textElem,t.text.attrs,t.text.attrsHover),i>0?a.textElem.animate(t.text.attrs,i):a.textElem.attr(t.text.attrs)),e.fn.mapael.setHoverOptions(a.mapElem,t.attrs,t.attrsHover),i>0?a.mapElem.animate(t.attrs,i):a.mapElem.attr(t.attrs),t.tooltip&&"undefined"!=typeof t.tooltip.content&&("undefined"==typeof a.mapElem.tooltipContent&&(e.fn.mapael.setTooltip(a.mapElem,n),a.textElem&&e.fn.mapael.setTooltip(a.textElem,n)),a.mapElem.tooltipContent=t.tooltip.content,a.textElem&&(a.textElem.tooltipContent=t.tooltip.content)),"undefined"!=typeof t.href&&("undefined"==typeof a.mapElem.href&&(e.fn.mapael.setHref(a.mapElem),a.textElem&&e.fn.mapael.setHref(a.textElem)),a.mapElem.href=t.href,a.textElem&&(a.textElem.href=t.href))},e.fn.mapael.drawPlot=function(t,a,n,i,o){var l={},s={},r=e.fn.mapael.getElemOptions(a.map.defaultPlot,a.plots[t]?a.plots[t]:{},a.legend.plot);return s=r.x&&r.y?{x:r.x,y:r.y}:n.getCoords(r.latitude,r.longitude),l="square"==r.type?{mapElem:i.rect(s.x-r.size/2,s.y-r.size/2,r.size,r.size).attr(r.attrs)}:{mapElem:i.circle(s.x,s.y,r.size/2).attr(r.attrs)},e.fn.mapael.initElem(i,l,r,o,t),l},e.fn.mapael.setHref=function(t){t.attr({cursor:"pointer"}),e(t.node).bind("click",function(){!e.fn.mapael.panning&&t.href&&(window.location=t.href)})},e.fn.mapael.setTooltip=function(t,a){var n=0,i=a.parent(),o=i.offset().left+i.width();e(t.node).on("mouseover",function(i){n=setTimeout(function(){t.tooltipContent&&a.html(t.tooltipContent).css("display","block"),a.css({left:Math.min(o-a.outerWidth()-5,i.pageX+12),top:i.pageY+23-e(window).scrollTop()})},120)}).on("mouseout",function(){clearTimeout(n),a.css("display","none")}).on("mousemove",function(t){a.css({left:Math.min(o-a.outerWidth()-5,t.pageX+12),top:t.pageY+23-e(window).scrollTop()})})},e.fn.mapael.setEventHandlers=function(t,a,n,i){for(var o in a.eventHandlers)!function(o){e(n.node).on(o,function(l){!e.fn.mapael.panning&&a.eventHandlers[o](l,t,n,i)}),i&&e(i.node).on(o,function(l){!e.fn.mapael.panning&&a.eventHandlers[o](l,t,n,i)})}(o)},e.fn.mapael.panning=!1,e.fn.mapael.initZoom=function(t,a,n,i,o){var l=t.parent(),s=e("<div>").addClass(o.zoomInCssClass).html("+"),r=e("<div>").addClass(o.zoomOutCssClass).html("&#x2212;"),m=!1,p=0,f=0;l.data("zoomLevel",0),t.append(s).append(r),l.on("zoom",function(e,t,s,r){var m=Math.min(Math.max(t,0),o.maxLevel);l.data("zoomLevel",m),"undefined"==typeof s&&(s=a._viewBox[0]+a._viewBox[2]/2),"undefined"==typeof r&&(r=a._viewBox[1]+a._viewBox[3]/2),0==m?a.setViewBox(0,0,n,i):a.setViewBox(Math.min(Math.max(0,s-n/(1+m*o.step)/2),n-n/(1+m*o.step)),Math.min(Math.max(0,r-i/(1+m*o.step)/2),i-i/(1+m*o.step)),n/(1+m*o.step),i/(1+m*o.step))}),s.on("click",function(){l.trigger("zoom",l.data("zoomLevel")+1)}),r.on("click",function(){l.trigger("zoom",l.data("zoomLevel")-1)}),e("body").on("mouseup",function(){m=!1,setTimeout(function(){e.fn.mapael.panning=!1},50)}),t.on("mousedown",function(e){return m=!0,p=e.pageX,f=e.pageY,!1}).on("mousemove",function(t){var s=l.data("zoomLevel");if(m&&0!=s){var r=(p-t.pageX)/(1+s*o.step)*(n/a.width),d=(f-t.pageY)/(1+s*o.step)*(i/a.height);(Math.abs(r)>5||Math.abs(d)>5)&&(a.setViewBox(Math.min(Math.max(0,a._viewBox[0]+r),n-a._viewBox[2]),Math.min(Math.max(0,a._viewBox[1]+d),i-a._viewBox[3]),a._viewBox[2],a._viewBox[3]),p=t.pageX,f=t.pageY,e.fn.mapael.panning=!0)}return!1})},e.fn.mapael.createLegend=function(t,a,n,i,o){var l=a.legend[n],s="plot"==n?e("."+a.legend.plot.cssClass,t).empty():e("."+a.legend.area.cssClass,t).empty(),r=new Raphael(s.get(0)),m=5,p=5,f={},d={},c={},u={};l.title&&(f=r.text(l.marginLeftTitle,l.marginBottom,l.title).attr(l.titleAttrs),m=l.marginLeftTitle+f.getBBox().width,p+=l.marginBottom+f.getBBox().height);for(var x=0,h=l.slices.length;h>x;++x)("undefined"==typeof l.slices[x].display||1==l.slices[x].display)&&(d="plot"==n?a.map.defaultPlot:a.map.defaultArea,l.slices[x].attrs=e.extend({},d.attrs,l.slices[x].attrs),l.slices[x].attrsHover=e.extend({},d.attrsHover,l.slices[x].attrsHover),"area"==n||"square"==l.slices[x].type?(!l.slices[x].size&&(l.slices[x].size=20),c=r.rect(l.marginLeft,p,o*l.slices[x].size,o*l.slices[x].size).attr(l.slices[x].attrs)):c=r.circle(l.marginLeft+o*(l.slices[x].size/2),p+o*(l.slices[x].size/2),o*(l.slices[x].size/2)).attr(l.slices[x].attrs),u=r.text(l.marginLeft+o*l.slices[x].size+l.marginLeftLabel,p+o*(l.slices[x].size/2),l.slices[x].label).attr(l.labelAttrs),p+=l.marginBottom+o*l.slices[x].size,m=Math.max(m,l.marginLeft+o*l.slices[x].size+l.marginLeftLabel+u.getBBox().width),l.hideElemsOnClick.enabled&&(u.attr({cursor:"pointer"}),e.fn.mapael.setHoverOptions(c,l.slices[x].attrs,l.slices[x].attrsHover),e.fn.mapael.setHoverOptions(u,l.labelAttrs,l.labelAttrsHover),e.fn.mapael.setHover(r,c,u),u.hidden=!1,function(t,a,n){e(n.node).on("click",function(){n.hidden?n.animate({opacity:1},300):n.animate({opacity:.5},300);for(var e in i)(!l.slices[t].min||i[e].value>=l.slices[t].min)&&(!l.slices[t].max||i[e].value<l.slices[t].max)&&!function(e){n.hidden?(0==l.hideElemsOnClick.opacity&&(i[e].mapElem.show(),i[e].textElem&&i[e].textElem.show()),i[e].mapElem.animate({opacity:"undefined"!=typeof i[e].mapElem.originalAttrs.opacity?i[e].mapElem.originalAttrs.opacity:1},300),i[e].textElem&&i[e].textElem.animate({opacity:"undefined"!=typeof i[e].textElem.originalAttrs.opacity?i[e].textElem.originalAttrs.opacity:1},300)):(i[e].mapElem.animate({opacity:l.hideElemsOnClick.opacity},300,"linear",function(){0==l.hideElemsOnClick.opacity&&i[e].mapElem.hide()}),i[e].textElem&&i[e].textElem.animate({opacity:l.hideElemsOnClick.opacity},300,"linear",function(){0==l.hideElemsOnClick.opacity&&i[e].textElem.hide()}))}(e);n.hidden=!n.hidden})}(x,c,u)));return"SVG"!=Raphael.type&&l.VMLWidth&&(m=l.VMLWidth),r.setSize(m,p),r},e.fn.mapael.setHoverOptions=function(t,a,n){"SVG"!=Raphael.type&&delete n.transform,t.attrsHover=n,t.originalAttrs=t.attrsHover.transform?e.extend({transform:"s1"},a):a},e.fn.mapael.setHover=function(t,a,n){var i={},o={},l=0,s=function(){l=setTimeout(function(){e.fn.mapael.elemHover(t,a,n)},120)},r=function(){clearTimeout(l),e.fn.mapael.elemOut(t,a,n)};i=e(a.node),i.on("mouseover",s),i.on("mouseout",r),n&&(o=e(n.node),o.on("mouseover",s),e(n.node).on("mouseout",r))},e.fn.mapael.elemHover=function(e,t,a){t.animate(t.attrsHover,t.attrsHover.animDuration),a&&a.animate(a.attrsHover,a.attrsHover.animDuration),e.safari()},e.fn.mapael.elemOut=function(e,t,a){t.animate(t.originalAttrs,t.attrsHover.animDuration),a&&a.animate(a.originalAttrs,a.attrsHover.animDuration),e.safari()},e.fn.mapael.getElemOptions=function(t,a,n){var i=e.extend(!0,{},t,a);return"undefined"!=typeof i.value&&e.extend(!0,i,e.fn.mapael.getLegendSlice(i.value,n)),i},e.fn.mapael.getTextPosition=function(e,t,a){var n=0,i=0,o="";switch(t){case"bottom":n=(e.x+e.x2)/2,i=e.y2+a,o="middle";break;case"top":n=(e.x+e.x2)/2,i=e.y-a,o="middle";break;case"left":n=e.x-a,i=(e.y+e.y2)/2,o="end";break;case"right":n=e.x2+a,i=(e.y+e.y2)/2,o="start";break;default:n=(e.x+e.x2)/2,i=(e.y+e.y2)/2,o="middle"}return{x:n,y:i,textAnchor:o}},e.fn.mapael.getLegendSlice=function(e,t){for(var a=0,n=t.slices.length;n>a;++a)if((!t.slices[a].min||e>=t.slices[a].min)&&(!t.slices[a].max||e<t.slices[a].max))return t.slices[a];return{}},e.fn.mapael.defaultOptions={map:{cssClass:"map",tooltip:{cssClass:"mapTooltip"},defaultArea:{attrs:{fill:"#343434",stroke:"#5d5d5d","stroke-width":1,"stroke-linejoin":"round"},attrsHover:{fill:"#f38a03",animDuration:300},text:{position:"inner",margin:10,attrs:{"font-size":15,fill:"#c7c7c7"},attrsHover:{fill:"#eaeaea",animDuration:300}}},defaultPlot:{type:"circle",size:15,attrs:{fill:"#0088db",stroke:"#fff","stroke-width":0,"stroke-linejoin":"round"},attrsHover:{"stroke-width":3,animDuration:300},text:{position:"right",margin:10,attrs:{"font-size":15,fill:"#c7c7c7"},attrsHover:{fill:"#eaeaea",animDuration:300}}},zoom:{enabled:!1,maxLevel:5,step:.25,zoomInCssClass:"zoomIn",zoomOutCssClass:"zoomOut"}},legend:{area:{cssClass:"areaLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},labelAttrsHover:{fill:"#787878",animDuration:300},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[]},plot:{cssClass:"plotLegend",display:!1,marginLeft:15,marginLeftTitle:5,marginLeftLabel:10,marginBottom:15,titleAttrs:{"font-size":18,fill:"#343434","text-anchor":"start"},labelAttrs:{"font-size":15,fill:"#343434","text-anchor":"start"},labelAttrsHover:{fill:"#787878",animDuration:300},hideElemsOnClick:{enabled:!0,opacity:.2},slices:[]}},areas:{},plots:{}}}(jQuery);